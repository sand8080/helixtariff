#!/bin/sh

#set -e

case "$1" in
    configure)

        if [ -f /usr/share/debconf/confmodule ]; then

            . /usr/share/debconf/confmodule
            db_version 2.0

            db_get helixtariff/hostname
            # hostname value now in RET
            . /opt/helixutils/substitute.sh
            echo "Setting $RET as server_name into nginx config"
            subst /etc/nginx/sites-available/helixtariff "server_name.*" "server_name  $RET;"

            if [ -f /usr/share/dbconfig-common/dpkg/postinst.pgsql  ]; then

                . /usr/share/dbconfig-common/dpkg/postinst.pgsql

                dbc_generate_include='template:/usr/share/python-support/helixtariff/helixtariff/conf/settings.py'
                dbc_generate_include_owner='helixtariff:root'
                dbc_generate_include_perms='640'
                dbc_generate_include_args="-U -o template_infile=/usr/share/helixtariff/settings.py.tpl"

                # you can set the default database encoding to something else
                dbc_pgsql_createdb_encoding="UTF8"

                dbc_go helixtariff $@

            fi
        fi

        if which update-python-modules >/dev/null 2>&1; then
            update-python-modules  helixtariff
        fi

        chown -R helixtariff:helixtariff /var/log/helixtariff
        chmod 750 /var/log/helixtariff

        echo "Installing helixtariff patches"
        sudo -u helixtariff /usr/share/helixtariff/helixtariff_install update

        echo "Installing nginx config"
        chmod 400 /etc/nginx/sites-available/helixtariff-ssl/*.key
        ln -f -s /etc/nginx/sites-available/helixtariff /etc/nginx/sites-enabled
        invoke-rc.d nginx reload

        echo "Installing helixtariff configuration into supervisor"
        ln -f -s /etc/supervisor/process-available/helixtariff.ini /etc/supervisor/process-enabled
        invoke-rc.d supervisor reload
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


